---
title: "Crontab を別のユーザのもので上書きしてしまった話"
date: 2020-12-26T07:00:00+09:00
description: 2 人で crontab をいじっていてやらかしたことを書きます
news_keywords:
  - Crontab
  - 本番環境
---

{{< alert type="info" >}}
こちらの記事は [本番環境でやらかしちゃった人 Advent Calendar 2020 - Qiita](https://qiita.com/advent-calendar/2020/yarakashi-production) 17 日目の記事です。
{{< /alert >}}

## 環境

CentOS

---

## やらかしたこと

root ユーザの Crontab を他の一般ユーザのもので上書きしました。

#### 背景

某平日の夜 9 時半ごろ、（当時）新卒 1 年目で開発チームの私と新卒 3 年目でインフラチームの先輩は障害対応にあたっており、 **Crontab の一部をコメントアウトする操作** を行おうとしていました。

> 私「もう眠いですよ～先輩、早くクーロン見ましょ :blush:」
>
> 先輩「うん、見よ見よ :yellow_heart: これをこうして... :computer::hammer:」
>
> 私「Crontab の確認って、 Crontab を確認したいユーザにログインして `crontab -l` じゃないんですか？ :thinking:」
>
> 先輩「ああ、それもあるけどわたしはいつも **root で `/var/spool/cron/${ユーザ名}` 見てる** よー :mag:」
>
> 私「へぇ～、初めて知りました。そういう方法もあるんですね :bulb:」

そして、いざ作業へ。

> 私「じゃあさっそく作業に入りますか :muscle:」
>
> 先輩「いいよー :+1:」
>
> 私「コマンドをこちらで言うので操作してもらっていいですか？ :sparkles:」
>
> 先輩「いいよー :ok_woman:」

**作業は先輩の PC で** 、画面を 2 人で見ながらやります。

Crontab の中身自体は **私の PC でローカルにダウンロードして編集** し、 SSH でアップロードするところまでが完了しています。

私は以前に `crontab -e` のタイポで `crontab -r` を打ってしまった方の記事を読んたことがありました。
だから Crontab の変更にあたって Crontab を直接編集することはせず、 `crontab -l > ${ファイル名}` でファイルにリダイレクトし、ファイルを編集してから `crontab ${ファイル名}` で反映させる方法を採用しています。

そしてファイルを編集し、反映させるときが来ました。

> 私「では反映いっちゃいますか」
>
> 先輩「いいよー、 **`crontab file.txt`** っと...いくよー？」
>
> 私「いいですよー！」
>
> 先輩「じゃあいきまーす、ちゅどーん :bomb:（Enter キーを叩きながら）」

Crontab の反映が完了しました。

...ん？あれ、ユーザ合ってたっけ？

ターミナルをもう一度見直すと、

```html
[root@centos ~]$
```

root ユーザで作業していました。

(後略)

#### どうやって復旧したか

事実上は障害が拡大したことになりますが、幸い、 **Crontab の中身は Git 管理下にあった** ため、 10 分ほどでそこから復元して事なきを得ています。

細かく見ると私の知識不足とか root で作業する必要性とかあると思うのですが、今回のオペミスの直接原因としては大きく 2 つあります。

---

## 惨劇はなぜおこってしまったのか

細かく見ると私の知識不足とかそもそも root で作業するなよとかあると思うのですが、今回のオペミスの直接原因としては大きく 2 つあります。

#### 実行ユーザの確認を怠った

コマンドの確認はしっかり行っていましたが、普段から「root ユーザで作業するときはどうせ sudo だし」とか「自分は root に入ることはまずないし」とかで、ユーザの確認をすることが少なかったように思います。

#### その場でコマンドを打って作業していた

もともと障害対応のため、早く対応しなければという焦りから、ターミナルで直接コマンドを打って作業していました。

---

## 二度と惨劇を起こさないためにどうしたのか

本番サーバでは、少しの作業でも

- ターミナル上でコマンドを直接打たない
- ユーザの確認を含めた手順書を作成する、もしくは急ぎであってもローカル PC のエディタにコマンドを下書きして、チェックしてからコピペ→実行する

ようにしました。

手順書作成中にファイルの場所を確認したりコマンドの存在を確認したりするなど、やむを得ない場合もありますが、ターミナルウィンドウがアクティブの時には、できるだけ「<kbd><kdb>Ctrl</kbd> + <kbd>V</kbd></kbd>」「<kbd>Enter</kbd>」「マウス操作」だけで操作を完結できるように気を付けました。

それからコマンドのミスをすることは大幅に減りました。

{{< alert type="success" >}}
コピペミス防止のための対策もあるといいと思います。
テキストを選択した状態でエディタでコピーした後、その場で 1 度貼り付け、テキストの中身が変化しなければちゃんとコピーできています。
{{< /alert >}}

{{< alert type="success" >}}
また、 `rm` や `chmod` など、みなさんがよく使用するコマンドには `-v (--verbose)` オプションがついているものも多く、「ファイル削除しましたよー」とか「権限変更しましたよー」のメッセージをターミナル上に表示することが可能です。
{{< /alert >}}

---

## さいごに

今回の教訓を受けて、私自身、身近なものへの意識を見直してみたいと思っています。

本番サーバもたくさん触れば身近なものになる。身近なものっておろそかにされそうなイメージがありませんか？
パソコンやスマホにしたって、一家に一台とか、一人一台持つようになる中で、とんでもない理由で故障するパターンが出てきましたよね（コーヒーこぼして動かなくなった :coffee: :sweat_drops: とか、踏んづけて画面割れた :feet: :boom: とか）。

本番サーバが身近な存在になっても、デリケートであることには変わりないのです。
みなさんも本番サーバで作業する際には私のようにならないようお気を付けください。

---

最後までお読みいただきありがとうございました :wink:
